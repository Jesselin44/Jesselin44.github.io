<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trivia Quiz - Play</title>

    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
        rel="stylesheet"
    >
</head>
<body class="bg-success-subtle">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="index.html">Trivia Quiz</a>
        <div class="navbar-nav">
            <a class="nav-link" href="index.html">Home</a>
            <a class="nav-link" href="docs.html">Docs</a>
        </div>
    </div>
</nav>

<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-md-8 mx-auto">

            <div class="card bg-success-subtle">
                <div class="card-body">
                    <h1 class="h4 mb-3 text-center">Trivia Quiz</h1>

                    <div id="loadingBox" class="alert alert-info" role="alert" >
                        Loading questions...
                    </div>

                    <div id="errorBox" class="alert alert-danger d-none" role="alert">
                        <!--Error text goes here -->
                    </div>

                    <!--Question area -->
                    <div id="quizBox" class="d-none">
                        <p class="small text-muted" id="questionInfo"></p>
                        <h2 class="h5" id="questionText"></h2>

                        <div id="answersContainer" class="mt-3" >
                            <!--Answer buttons go here -->
                        </div>

                        <hr class="my-4">

                        <p id="progressText" class="small text-muted"></p>
                        <p id="scoreText" class="small text-muted"></p>

                        <button 
        
                            type="button" 
                            class="btn btn-secondary mt-3"
                            onclick="goBackHome()"
                        >
                            Back to Home
                        </button>
                    </div>

                    <!--area with results-->
                    <div id="resultBox" class="d-none">
                        <h2 class="h5 mb-3">Quiz Finished!</h2>
                        <p id="finalScoreText"></p>

                        <button 
                            type="button" 
                            class="btn btn-primary me-2"
                            onclick="restartQuiz()"
                        >
                            Play Again with Same Settings
                        </button>

                        <button 
                            type="button" 
                            class="btn btn-secondary"
                            onclick="goBackHome()"
                        >
                            Back to Home
                        </button>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

var questions = [];
var currentIndex = 0;
var score = 0;
var totalQuestions = 0;


function decodeHTML(text) {
    var tempElement = document.createElement("textarea");
    tempElement.innerHTML = text;
    return tempElement.value;
}

// this gets the query parameters from URL 
function getQueryParams() {
    var params = {};
    var query = window.location.search.substring(1);
    var pairs = query.split("&");

    for (var i = 0; i < pairs.length; i++) {
        var pair = pairs[i];
        if (pair === "") {
            continue;
        }
        var parts = pair.split("=");
        var key = decodeURIComponent(parts[0]);
        var value = decodeURIComponent(parts[1] || "");
        params[key] = value;
    }
    return params;
}

// loads questions from the API
function loadQuestions() {
    var loadingBox = document.getElementById("loadingBox");
    var errorBox = document.getElementById("errorBox");
    var quizBox = document.getElementById("quizBox");

    var params = getQueryParams();

    var amount = params.amount || "5";
    var category = params.category || "";
    var difficulty = params.difficulty || "";

    
    var apiUrl = "https://opentdb.com/api.php?amount=" + encodeURIComponent(amount);

    if (category !== "") {
        apiUrl += "&category=" + encodeURIComponent(category);
    }
    if (difficulty !== "") {
        apiUrl += "&difficulty=" + encodeURIComponent(difficulty);
    }

    fetch(apiUrl)
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.response_code !== 0 || data.results.length === 0) {
                loadingBox.classList.add("d-none");
                errorBox.textContent = "No questions found for the selected options. Please go back and try different settings.";
                errorBox.classList.remove("d-none");
                return;
            }

            questions = data.results;
            totalQuestions = questions.length;

            loadingBox.classList.add("d-none");
            quizBox.classList.remove("d-none");

            showQuestion();
        })
        .catch(function(error) {
            loadingBox.classList.add("d-none");
            errorBox.textContent = "Could not load questions. Please check your internet connection and try again.";
            errorBox.classList.remove("d-none");
        });
}

//Shows the current question and its answers
function showQuestion() {
    var question = questions[currentIndex];

    var questionInfo = document.getElementById("questionInfo");
    var questionText = document.getElementById("questionText");
    var answersContainer = document.getElementById("answersContainer");
    var progressText = document.getElementById("progressText");
    var scoreText = document.getElementById("scoreText");

    // this to wipe away previous answers
    answersContainer.innerHTML = "";

    // Fillin of questions text and info
    questionInfo.textContent = "Category: " + decodeHTML(question.category) +
        " | Difficulty: " + decodeHTML(question.difficulty);
    questionText.textContent = decodeHTML(question.question);

    var answers = question.incorrect_answers.slice(); // copy
    answers.push(question.correct_answer);

    // easy shuffle
    for (var i = answers.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = answers[i];
        answers[i] = answers[j];
        answers[j] = temp;
    }

    //Creation of buttons for each answer
    for (var k = 0; k < answers.length; k++) {
        var btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-primary w-100 text-start mb-2";
        btn.textContent = decodeHTML(answers[k]);

        btn.onclick = (function(selectedAnswer) {
            return function() {
                handleAnswer(selectedAnswer);
            };
        })(answers[k]);

        answersContainer.appendChild(btn);
    }

    progressText.textContent = "Question " + (currentIndex + 1) + " of " + totalQuestions;
    scoreText.textContent = "Current score: " + score;
}

// Handling of the users answer
function handleAnswer(selectedAnswer) {
    var question = questions[currentIndex];
    var correct = question.correct_answer;

    if (selectedAnswer === correct) {
        score++;
        alert("Correct!");
    } else {
        alert("Incorrect. The correct answer was: " + decodeHTML(correct));
    }

    currentIndex++;

    if (currentIndex < totalQuestions) {
        showQuestion();
    } else {
        showResult();
    }
}

//final result showcased
function showResult() {
    var quizBox = document.getElementById("quizBox");
    var resultBox = document.getElementById("resultBox");
    var finalScoreText = document.getElementById("finalScoreText");

    quizBox.classList.add("d-none");
    resultBox.classList.remove("d-none");

    finalScoreText.textContent = "You scored " + score + " out of " + totalQuestions + ".";
}

// option to restart quiz with same URL parameters
function restartQuiz() {
    // Simply reload the page; it will read the same query params again
    window.location.reload();
}

// Going back to index.html
function goBackHome() {
    window.location.href = "index.html";
}

// Load questions when the page is ready
window.onload = function() {
    loadQuestions();
};
</script>

</body>
</html>
